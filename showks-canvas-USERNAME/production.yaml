resources:
- name: app-master
  type: git
  source:
    uri: https://github.com/containerdaysjp/showks-canvas-USERNAME
    branch: master

- name: concourse-pipelines
  type: git
  source:
    uri: https://github.com/containerdaysjp/showks-concourse-pipelines
    branch: master

- name: showks-canvas-USERNAME-image
  type: docker-image
  source:
    repository: containerdaysjp/showks-canvas-USERNAME
    username: ((registry_user))
    password: ((registry_password))

jobs:
- name: master
  plan:
  - get: app-master
    trigger: true
  - get: concourse-pipelines
  - task: from-staging-image-to-master
    file: concourse-pipelines/common/tasks/tagging.yaml
    params:
      GITREPO: app-master/
      IMAGE_NAME: containerdaysjp/showks-canvas-USERNAME

  - put: showks-canvas-USERNAME-image
    params:
      # from-staging-image-to-master/app-master/image.tgz
      # load_file: app-master/image.tgz
      # load_repository: 
      # import_file: outfile/image.tar
      load_file: outfile/image
      load_repository: containerdaysjp/showks-canvas-USERNAME
      load_tag: latest
      # stg-e31c82b3fa1bc7e3ed190930a2714958967e03c0
      tag_file: app-master/.git/refs/heads/master
      tag_prefix: prod-
